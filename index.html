<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Start Vitals</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3498db">
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f5 url('icon-512.png') center center no-repeat;
        background-size: 350px;
        color: #333;
    }
    header {
        background: #007bff;
        color: white;
        padding: 10px;
        text-align: center;
        font-size: 22px;
        font-weight: bold;
    }
    .tabs {
        display: flex;
        justify-content: space-around;
        background: #e0e0e0;
        padding: 10px;
    }
    .tabs button {
        padding: 10px;
        border: none;
        background: #d0d0d0;
        border-radius: 6px;
        cursor: pointer;
    }
    .tabs button.active {
        background: #007bff;
        color: white;
    }
    .tab-content {
        display: none;
        padding: 15px;
    }
    .tab-content.active {
        display: block;
    }
    input, select, textarea, button {
        width: 100%;
        margin: 6px 0;
        padding: 8px;
        box-sizing: border-box;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 16px;
    }
    button {
        background: #007bff;
        color: white;
        border: none;
        font-weight: bold;
        cursor: pointer;
    }
    button:hover {
        background: #0056b3;
    }
    .alert {
        padding: 8px;
        margin: 8px 0;
        border-radius: 6px;
        font-weight: bold;
        display: none;
    }
    .alert.warning { background: #ffc107; color: #000; }
    .alert.danger { background: #dc3545; color: white; }
</style>
<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
            for (let reg of registrations) { reg.unregister(); }
        });
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js?version=' + new Date().getTime());
        });
    }
</script>
</head>

<body>
<header>Start Vitals</header>

<div class="tabs">
    <button class="active" onclick="openTab('info')">Patient Info</button>
    <button onclick="openTab('vitals')">Vitals</button>
    <button onclick="openTab('gcs')">GCS</button>
    <button onclick="openTab('results')">Results</button>
</div>

<!-- Patient Info -->
<div id="info" class="tab-content active">
    <label>Responder ID:</label>
    <input type="text" id="responder-id" placeholder="e.g., ST186">
    <label>Incident Type:</label>
    <input type="text" id="incident-type" placeholder="e.g., MVA, Suspected Heart Attack">
    <label>Name:</label>
    <input type="text" id="patient-name">
    <label>Age:</label>
    <input type="number" id="patient-age">
    <label>Allergies:</label>
    <input type="text" id="allergies">
    <label>Medication:</label>
    <input type="text" id="medication">
    <label>Past History:</label>
    <textarea id="history"></textarea>
    <label>Last Intake:</label>
    <input type="text" id="last-intake">
</div>

<!-- Vitals -->
<div id="vitals" class="tab-content">
    <div id="vital-alert" class="alert danger"></div>
    <label>BP (mmHg):</label>
    <input type="text" id="bp">
    <label>Pulse (bpm):</label>
    <input type="number" id="pulse">
    <label>SPO₂ (%):</label>
    <input type="number" id="spo2">

    <!-- Oxygen options below SPO2 -->
    <label>On O₂:</label>
    <select id="o2source">
        <option value="Room Air">Room Air</option>
        <option value="Nasal Cannula">Nasal Cannula</option>
        <option value="Non-Rebreather">Non-Rebreather</option>
    </select>
    <label>O₂ Flow Rate (L/min):</label>
    <input type="number" id="o2flow" placeholder="e.g., 5">

    <label>Resp Rate (/min):</label>
    <input type="number" id="rrate">
    <label>Temperature (°C):</label>
    <input type="number" id="temp" step="0.1">
    <label>Cap Refill (sec):</label>
    <input type="number" id="caprefill">
    <label>Pupils (L):</label>
    <input type="number" id="pupil-left" step="0.1">
    <label>Pupils (R):</label>
    <input type="number" id="pupil-right" step="0.1">
    <label>Pain (/10):</label>
    <input type="number" id="pain" min="0" max="10">
    <button onclick="submitVitals()">Submit Vitals</button>
</div>

<!-- GCS -->
<div id="gcs" class="tab-content">
    <div id="gcs-alert" class="alert danger"></div>
    <label>Eye Response (E):</label>
    <select id="eye">
        <option value="4">4 - Spontaneous</option>
        <option value="3">3 - To Speech</option>
        <option value="2">2 - To Pain</option>
        <option value="1">1 - None</option>
    </select>
    <label>Verbal Response (V):</label>
    <select id="verbal">
        <option value="5">5 - Oriented</option>
        <option value="4">4 - Confused</option>
        <option value="3">3 - Inappropriate</option>
        <option value="2">2 - Incomprehensible</option>
        <option value="1">1 - None</option>
    </select>
    <label>Motor Response (M):</label>
    <select id="motor">
        <option value="6">6 - Obeys Commands</option>
        <option value="5">5 - Localizes Pain</option>
        <option value="4">4 - Withdraws</option>
        <option value="3">3 - Flexion</option>
        <option value="2">2 - Extension</option>
        <option value="1">1 - None</option>
    </select>
    <button onclick="submitGCS()">Submit GCS</button>
</div>

<!-- Results -->
<div id="results" class="tab-content">
    <textarea id="results-output" rows="20" readonly></textarea>
    <button onclick="generateResults()">Generate Report</button>
    <button onclick="copyResults()">Copy to Clipboard</button>
</div>

<script>
let vitalsLog = [];
let gcsLog = [];

function openTab(id) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelector(`.tabs button[onclick="openTab('${id}')"]`).classList.add('active');
}

// Submit Vitals
function submitVitals() {
    const bp = document.getElementById('bp').value;
    const pulse = +document.getElementById('pulse').value;
    const spo2 = +document.getElementById('spo2').value;
    const o2source = document.getElementById('o2source').value;
    const o2flow = document.getElementById('o2flow').value;
    const rrate = +document.getElementById('rrate').value;
    const temp = +document.getElementById('temp').value;
    const caprefill = +document.getElementById('caprefill').value;
    const pupilsL = +document.getElementById('pupil-left').value;
    const pupilsR = +document.getElementById('pupil-right').value;
    const pain = +document.getElementById('pain').value;

    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    const entry = { bp, pulse, spo2, o2source, o2flow, rrate, temp, caprefill, pupilsL, pupilsR, pain, time };
    vitalsLog.push(entry);

    // Trend alerts
    if (vitalsLog.length > 1) {
        const prev = vitalsLog[vitalsLog.length - 2];
        if (pulse - prev.pulse > 20 || spo2 - prev.spo2 < -3) {
            showAlert('vital-alert', '⚠️ Possible deterioration detected!', 'danger');
        }
    }

    document.querySelectorAll('#vitals input').forEach(i => i.value = '');
    document.querySelectorAll('#vitals select').forEach(s => s.selectedIndex = 0);
}

// Submit GCS
function submitGCS() {
    const eye = +document.getElementById('eye').value;
    const verbal = +document.getElementById('verbal').value;
    const motor = +document.getElementById('motor').value;
    const gcs = `Total GCS Score: ${eye + verbal + motor} / 15 (E${eye} V${verbal} M${motor})`;
    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    gcsLog.push({ gcs, time });

    if (gcsLog.length > 1) {
        const prev = parseInt(gcsLog[gcsLog.length - 2].gcs.match(/\d+/)[0]);
        const current = eye + verbal + motor;
        if (current < prev) showAlert('gcs-alert', '⚠️ GCS drop detected!', 'danger');
    }

    document.querySelectorAll('#gcs select').forEach(s => s.selectedIndex = 0);
}

function showAlert(id, msg, type) {
    const alertBox = document.getElementById(id);
    alertBox.innerText = msg;
    alertBox.className = `alert ${type}`;
    alertBox.style.display = 'block';
    setTimeout(() => { alertBox.style.display = 'none'; }, 3000);
}

// Generate Report
function generateResults() {
    const info = {
        responder: document.getElementById('responder-id').value,
        incident: document.getElementById('incident-type').value,
        name: document.getElementById('patient-name').value,
        age: document.getElementById('patient-age').value,
        allergies: document.getElementById('allergies').value,
        medication: document.getElementById('medication').value,
        history: document.getElementById('history').value,
        intake: document.getElementById('last-intake').value
    };
    let report = `--- PATIENT HANDOVER REPORT ---\n\nResponder ID   : ${info.responder}\nIncident Type  : ${info.incident}\nName           : ${info.name}\nAge            : ${info.age}\nAllergies      : ${info.allergies}\nMedication     : ${info.medication}\nPast History   : ${info.history}\nLast Intake    : ${info.intake}\n\n--- VITALS ---\n`;
    vitalsLog.forEach(v => {
        report += `BP: ${v.bp} mmHg ${v.time}\nPulse: ${v.pulse} bpm ${v.time}\nSPO₂: ${v.spo2}% (${v.o2source}, ${v.o2flow} L/min) ${v.time}\nResp Rate: ${v.rrate}/min ${v.time}\nTemp: ${v.temp} °C ${v.time}\nCap Refill: ${v.caprefill}s ${v.time}\nPupils: L ${v.pupilsL} mm / R ${v.pupilsR} mm ${v.time}\nPain: ${v.pain}/10 ${v.time}\n\n`;
    });
    report += "--- GCS ---\n";
    gcsLog.forEach(g => { report += `${g.gcs} ${g.time}\n`; });
    report += "\n--- SIGNS / SYMPTOMS ---\n" + document.getElementById('signs-symptoms')?.value + "\n\n--- ADDITIONAL NOTES ---\n" + document.getElementById('general-notes')?.value;
    document.getElementById('results-output').value = report;
}

function copyResults() {
    const output = document.getElementById('results-output');
    output.select();
    document.execCommand('copy');
    showAlert('gcs-alert', 'Copied to clipboard!', 'warning');
}
</script>

</body>
</html>
